<h1>シフト一覧</h1>

<% if flash[:alert].present? %>
  <div class="flash-alert"><%= flash[:alert] %></div>
<% end %>

<% base = @base_date %>
<% month_start = @base_date.beginning_of_month %>
<% month_end   = @base_date.end_of_month %>

<% # カレンダーを　六週分に固定（静的） %>
<% calendar_start = month_start.beginning_of_week(:sunday) %>
<% calendar_end = month_end.end_of_week(:sunday) %>

<div class="calendar-container">
  <div class="calendar-header">
    <div class="calendar-left">
      <%= link_to "＜".html_safe, shifts_path(month: @base_date.prev_month.strftime("%Y-%m")), class: "calendar-nav-button" %>
      <%= link_to "＞".html_safe, shifts_path(month: @base_date.next_month.strftime("%Y-%m")), class: "calendar-nav-button" %>
    </div>

    <div class="calendar-center">
      <h2><%= @base_date.strftime('%Y年%m月') %></h2>
    </div>

    <div class="calendar-right">
      <%= link_to 'シフト登録', new_shift_path, class: "btn btn-primary" %>
    </div>
  </div>

  <table class="calendar">
    <thead>
      <tr>
        <th>日</th>
        <th>月</th>
        <th>火</th>
        <th>水</th>
        <th>木</th>
        <th>金</th>
        <th>土</th>
      </tr>
    </thead>
    <tbody>
      <% 6.times do |week| %>
        <tr>
          <% 7.times do |wday| %>
            <% day = calendar_start + (week * 7 + wday).days%>
            <% shifts = @shifts_by_date[day] || [] %>
            <% is_holiday = Shift::WEEKLY_HOLIDAYS.include?(day.wday) %>

            <td class="<%= ['is-other-month', ('holiday' if is_holiday)].compact.join(' ') %>">
              <div class="calendar-day-number">
                <% if is_holiday %>
                  <span class="calendar-day-label"><%= day.day %></span>
                <% else %>
                  <%= link_to day.day, new_shift_path(work_date: day), class: "calendar-day-link" %>
                <% end %>
              </div>
                
                <% if is_holiday %>
                  <div class="calendar-day-note">定休日</div>
                <% end %>

                <% if shifts.any? %>
                  <ul class="calendar-shifts">
                    <% shifts.each do |shift| %>
                      <li class="calendar-shift-item">
                        <%= link_to shift_path(shift), class: "calendar-shift-link" do %>
                          <%= shift.start_time&.strftime("%H:%M") %>〜
                          <%= shift.end_time&.strftime("%H:%M") %>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                <% end %>
            </td>
            <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
            

